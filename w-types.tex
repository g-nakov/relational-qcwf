\documentclass[12pt,a4paper]{article}
\input{preamble.tex}

\autodefs{\bR\dN\binl\binr\bcase}
\title{\vspace{-5em}Outline}
\date{\vspace{-3em}}

\begin{document}
\maketitle

\section{Quantitative polynomial functors}
\subsection{Category of closed types and linear functions}
\label{sec:cat-closed-types}
Let $\cC$ be the category of closed types and linear functions $f : (x \of {1} X) \to Y $ for which derivations in QTT exist. Composition of morphisms $\Gamma \vdash f \of{\sigma} (x \of{1} X) \to Y$ and $\Gamma \vdash g \of{\sigma} (y \of{1} Y) \to Z$ is given by ordinary function composition $\Gamma \vdash \lambda x \of{1} X. g(f(x)) \of{\sigma} (x \of{1} X) \to Z $.\\

The linearity restriction on the morphisms does not lead to loss of expressiveness - a function with arbitrary resource annotations can be represented as linear one via the exponential type $!_\rho A \define (a \of{\rho} A) \otimes I$.

For an arbitrary $\Gamma \vdash f \of{1} X \ofto{\rho} Y$, the embedding is given by:
\begin{align*}
  f \mapsto \lambda z \of{1} (a \of{\rho}X) \otimes I . \text{ let } &(x,i) = z \text{ in} \\
  &\text{let } * = i \text{ in } f(x) \of{1}  ((a \of{\rho}X) \otimes I) \ofto{1} Y
\end{align*}
Suppose $\cD$ stands for the derivation of $\Gamma \vdash f \of{1} X \ofto{\rho} Y$ and  $\cD_x$, $\cD_z$ and $\cD_i$ for the derivations of $0\Gamma, x \of{1} X \vdash x \of{1} X$ \, , $0\Gamma, z \of{1}(a \of{\rho}X) \otimes I \vdash z \of{1} (a \of{\rho}X) \otimes I$ and $0\Gamma , i \of{1} I \vdash i \of{1} I$ obtained by the applications of the $\tt{Var}$ rule.
$$
\infer{\Gamma \vdash \lambda z \of{1} (a \of{\rho}X) \otimes I).\text{let } (x, z) = z \text{ in }  \text{let } * = i \text{ in } f(x) \of{1} (a \of{\rho}X) \otimes I) \ofto{1} Y}{
  \infer{\Gamma, z \of{1} (a \of{\rho}X) \otimes I) \vdash  \text{let } (x, z) = z \text{ in }  \text{let } * = i \text{ in } f(x) \of{1} Y}{
    \cD_z 
    &
    \infer{\Gamma, x \of{\rho} X, i \of{1} I \vdash \text{let } * = i \text{ in } f(x) \of{1} Y}{
      \cD_i
      & 
      \infer{\Gamma, x \of{\rho} X \vdash f(x) \of{1} Y}{
        \cD_x
        &
        \cD
      }
    }
  }
}
$$

\subsection{Category of closed types and linear functions in a nonempty context}

Let $\Delta$ be an ``underlying context'', i.e.\ a context of the form $\Delta = 0\Gamma_0$ for some $\Gamma_0$. There is a category $\cC_\Delta$ where the objects are types   $X$ such that $\Delta \vdash X \text{ type}$, and a morphism $X$ to $Y$ consists of pair $(\Gamma, f)$, where $\Gamma$ is a context such that $0\Gamma = \Delta$, and $\Gamma \vdash f : X \ofto{1} Y$.

\begin{itemize}
\item The identity morphism is given by $(\Delta, \lambda x . x)$;
\item Composition of $(\Gamma_2, g)$ and $(\Gamma_1, f)$ is given by $(\Gamma_1 + \Gamma_2, \lambda x . f(g(x)))$.
\end{itemize}

This is a category since $0\Delta = \Delta$, and context addition is associative, and with $\Gamma + \Delta = \Delta + \Gamma = \Gamma$. Note that the category of $\cC$ closed types from \cref{sec:cat-closed-types} is a special case $\cC = \cC_{\emptyCtxt}$ where $\Delta = \emptyCtxt$, because the only $\Gamma$ with $0\Gamma = \emptyCtxt$ is $\Gamma = \emptyCtxt$.

\begin{lemma}
  Fix $\Delta$ as above, and let $\Delta \vdash A \text{ type}$ and $\Delta, x \of{0} A \vdash B[x] \text{ type}$. The operation $F(X) = (a \of{1} A) \otimes (Ba \overset{1}\to X)$ is a functor $\cC_\Delta \to \cC_\Delta$.
\end{lemma}
\begin{proof}
  If $\Delta \vdash X \text{ type}$ then $\Delta \vdash F(X) \text{ type}$. On morphisms, we can define
  \[
    F(\Gamma, f) = (\Gamma, \lambda z . \letin{a, h}{z}{(a, \lambda b . f(h(b)))})
  \]
  as the following derivation shows:
  \[
    \infer{\Gamma \vdash \lambda z . \letin{a, h}{z}{(a, \lambda b . f(h(b)))} : F(X) \ofto{1} F(Y)}
       {\infer{\Gamma, z \of{1} F(X) \vdash \letin{a, h}{z}{(a, \lambda b . f(h(b)))} : F(Y)}
          { \infer{\Gamma, z \of{0} F(X), a \of{1} A, h \of{1} B[a] \ofto{1} X \vdash (a, \lambda b . f(h(b))) : F(Y)}{\infer{0\Gamma, z \of{0} F(X), a \of{1} A, h \of{0} B[a] \ofto{1} X \vdash a : A}{} & \quad \deduce{\cD}{\vdots}} & \quad \infer{0\Gamma, z \of{1} F(X) \vdash z : F(X)}{}}}
      \]
      where $\cD$ is the derivation
      \[
                 {
            \infer{\Gamma, a \of{0} A, h \of{1} B[a] \ofto{1} X \vdash \lambda b . f(h(b)) : B[a] \ofto{1} Y}{ \infer{\Gamma, a \of{0} A, h \of{1} B[a] \ofto{1} X, b \of{1} B[a]  \vdash f(h(b)) : Y}{ {\Gamma, a \of{0} A, h \of{0} B[a] \ofto{1} X, b \of{0} B[a] \vdash f : X \ofto{1} Y} & \quad \deduce{\cD'}{\vdots} }} }
        \]
        weakened by $z \of{0} F(X)$, where again $\cD'$ is the derivation
        \[
\infer{0\Gamma, a \of{0} A, h \of{1} B[a] \ofto{1} X, b \of{1} B[a] \vdash h(b) : X}{\infer{0\Gamma, a \of{0} A, h \of{1} B[a] \ofto{1} X, b \of{0} B[a] \vdash h : B[a] \ofto{1} X}{} & \quad \infer{0\Gamma, a \of{0} A, h \of{1} B[a] \ofto{0} X, b \of{1} B[a] \vdash b : B[a]}{}}
\]
similarly weakened. This is functorial by the $\eta$-rules for functions and pairs.
\end{proof}


\subsection{Internal representation}
Let $F_0 : Obj(\cC) \to Obj(\cC) $ be the function mapping a type $X$ to the type $(a \of{1} A) \otimes (Ba \ofto{1} X)$. 
\begin{claim}
  $F_0$ can be extended to an endofunctor $F : \cC \to \cC$.
\end{claim}
Suppose $\Gamma \vdash f \of{1} X \ofto{1} Y$ is some morphism with a derivation $\cD_f$, then $Ff: (a \of{1} A) \otimes (Ba \ofto{1} X) \ofto{1} (a \of{1} A) \otimes (Ba \ofto{1} Y)$ is defined by precomposition with $f$ on the second component.\\

By applying $\tt{Var}$ rule, we get the following:
\begin{itemize}
  \item a derivation $\cD_a$ of $0\Gamma, a \of{1} A, g \of{0} B a \ofto{1} X \vdash a \of{1} A$ 
  \item a derivation $\cD_g$ of $0\Gamma, a \of{0} A, g \of{1} B a \to X \vdash g \of{1} B a \ofto{1} X$
  \item a derivation $\cD_b$ of $0\Gamma, a \of{0} A, g \of{0} B a \to X, b \of{1} B a \vdash b \of{1} B a $ 
  \item a derivation $\cD_z$ of $0\Gamma, z \of{1} (a \of{1} A) \otimes (B a \ofto{1} X) \vdash z \of{1} (a \of{1} A) \otimes (B a \ofto{1} X)$
\end{itemize}
Form an intermediate derivation $\cD$ by : 
$$ 
\infer[\otimes-intro]{\Gamma, a \of{1} A, g \of{1} B a \overset{1}\to X \vdash (a, \lambda b \of{1} B a. f(g(b))) \of{1} F(Y)}{
  \cD_a
  &
  \infer[Abs]{0\Gamma, a \of{0} A, g \of{1} B a \to X, f \of{1} X \ofto{1} Y \vdash \lambda b .f(g(b)) \of{1} Ba \ofto{1} Y }{
    \infer[App]{0\Gamma, a \of{0} A, g \of{1} B a \to X, b \of{1} B a, f \of{1} X \ofto{1} Y \vdash f(g(b)) \of{1} Y }{
      D_f 
      &
      \infer[App]{0\Gamma, a \of{0} A, g \of{1} B a \to X, b \of{1} B a \vdash g(b) \of{1} X }{
        D_g & D_b
      }
    }
  }
}
$$

and use it to get a final one for $Ff$:

$$\infer[Lam]{\Gamma \vdash \lambda z.\text{let } (x,u) = a \text{ in } (x , \lambda b \of{1} Ba. f(u(b))) \of{1} F(X) \ofto{1} F(Y)}{
  \infer[\oplus-E]{\Gamma,  z \of{1} F(X)) \vdash \text{let } (x,u) = a \text{ in } (x , \lambda b \of{1} Ba. f(u(b))) \of{1} F(Y)}
  {
    \cD_z
    &
    \cD
  }
}
$$
\begin{definition}
  We will call any functor isomorphic to $F$ a quantitative polynomial functor.
\end{definition}
\subsection{External representation (using adjoints)}

\subsection{Generalising to non-empty contexts}
\subsection{Properties of quantitative polynomial functors}

\section{Algebras for QPFs}
Recall that an algebra for an endofunctor $F : \cC \to \cC$ is a pair $(X, a)$, where $X$ is an object of $\cC$ and $a$ - a morphism $F(X) \to X$. A morphism between $F$-algebras is a map $f : X \to Y$, making the square commute:
$$
\begin{tikzcd}
  F(X) \arrow[dd, "a"'] \arrow[rr, "F(f)"] &  & F(Y) \arrow[dd, "b"] \\
  &  &                      \\
  X \arrow[rr, "f"]                        &  & Y                   
\end{tikzcd}
$$

\subsection{$\dN$}
Fix $A \define \mathbf{Bool}$ and $B$, such that $B(false) \define \emptyset$ and $B(true) \define I$ where $x \of{1} A \vdash B$ type.

\textbf{Sketch}:

Observe that a function $\Gamma \vdash f\of{1} F_{A,B}(X) \ofto{1} X$ is equivalent to functions $\Gamma \vdash f_l \of{1} (\emptyset \ofto{1} X) \to X$ and $\Gamma \vdash f_r : (I \ofto{1} X) \to X$.

Assuming that the type $\emptyset \ofto{1} X$ is a (sub?)singleton (or $\emptyset \ofto{1} X \cong I$, but maybe too strong), $f_l$ just encodes a choice of an element of $X$. Similarly, $I\ofto{1} X$ also encodes the same data, that is $ I \ofto{1} X \cong X$ (provable in QTT?).

Essentially, an algebra for $F_{A,B}$ is a diagram $I \to X \to X$.\

Now, we prove the following propositions:
\begin{enumerate}
  \item[(i)] Suppose $\Gamma \vdash \mathbf{Nat}$ type, then there exists an initial algebra for $F_{A,B}(\mathbf{Nat})$
  \item[(ii)]  Suppose $\Gamma \vdash X$ type, such that there exists an initial algebra for $F_{A,B}(X)$, then $F_{A,B}(X) \cong \mathbf{Nat}$.
\end{enumerate}

Before embarking on proving that, let's examine a simpler construction:
\paragraph{Interlude : Pseudobooleans as a constant QPF}
Let $A \define \mathbf{Bool}$, $\Gamma, a \of{1} A \vdash B$ type, $B(a) \define \emptyset$.
An algebra for this $F_{A,B}(X)$ is a diagram $X \leftarrow \{ * \} \to X$.\\

Assume $\Gamma \vdash \mathbf{Bool}$ type. Then define $t(i) \define true$ and $f(i) \define false$ using the unit elimination.
Let $(F_{A,B}(Y), m, n)$ be another algebra. Define $\phi(x) \define Elim(m(*), n(*), k)$, where $k : F_{A,B}(\mathbf{Bool}) \ofto{1} \mathbf{Bool}$ is the structure map. The squares commute by the computation rules for $\mathbf{Bool}$.
$$\begin{tikzcd}
  \mathbf{Bool} \arrow[dd, "\phi"] &  & \{*\} \arrow[ll, "t"'] \arrow[rr, "f"] \arrow[dd, equal] &  & \mathbf{Bool} \arrow[dd, "\phi"] \\
  &  &                                                               &  &                                  \\
  Y                                &  & \{*\} \arrow[ll, "m"] \arrow[rr, "n"']                        &  & Y                               
\end{tikzcd}$$

Conversely, assume that there is an initial algebra $(X, k : F_{A,B}{X} \to X)$. Designate some elements $t,f \in X$, such that $t \neq f$. For any other algebra represented diagrammatically $(Y, m : I \ofto{1} Y,  n : I \ofto{1} Y)$, we have that $\phi(t) = m$ and $\phi(f) = n$ by initiality. Define $Elim(m, n, x) \define \phi(x)$.\\


Back to $\dN$, let $\mathbf{Nat}$ be defined as:
\begin{figure}[h]
  \begin{gather*}
    \begin{align*}
      \infer[\text{Nat}]{0\Gamma \vdash \mathbf{Nat}}{
        0\Gamma \vdash A
      } & & 
      \infer{0\Gamma \vdash 0 \of{\sigma} \mathbf{Nat}}
      { 0\Gamma \vdash
      }
      & &
      \infer[\text{suc}]{\Gamma \vdash suc(N) \of{\sigma} \mathbf{Nat}}{
        \Gamma \vdash N \of{\sigma} \mathbf{Nat}
      }\\
    \dots
    \end{align*}
  \end{gather*}
\end{figure}

$$
\begin{tikzcd}
  &  & X \arrow[dd, "\phi"] \arrow[rr, "\sigma"] &  & X \arrow[dd, "\phi"] \\
  I \arrow[rru, "\mu"] \arrow[rrd, "z"] &  &                                           &  &                      \\
  &  & Y \arrow[rr, "s"]                         &  & Y                   
\end{tikzcd}$$

\subsection{Lists}
\subsection{Trees}

\subsection{Induction principle}

\section{Rules for W-types in QTT}
\section{Parametricity and W-types}

\newpage
\section{Appendix}
\subsection{(Stand-alone) Sum types}
\begin{figure}[h]
  \begin{gather*}
    \begin{align*}
      \infer[\oplus\text{-type}]{0\Gamma \vdash \rho A \oplus \pi B}{
        0\Gamma \vdash A &
        0\Gamma \vdash B} & & 
      \infer[\text{inl}]{\rho \Gamma \ \vdash \mathbf{inl}\, S_1 \of \sigma \rho A \oplus \pi B}{
        \Gamma \vdash S_1 \of{\sigma} A} & &
      \infer[\text{inr}]{\pi\Gamma \vdash \mathbf{inr}\, S_2 \of \sigma \rho A \oplus \pi B}{
        \Gamma \vdash S_2 \of{\sigma} B
      }
    \end{align*}\\
    \\
    0\Gamma, x \of{0} \rho A \oplus \pi B \vdash C \\
    \infer[\oplus \text{-elim}]{\Gamma' + \Gamma \vdash \bcase(M , T_1 , T_2)\of{ \sigma}C[M/x]}{
      \Gamma \vdash M \of{\sigma} \rho A \oplus \pi B &&
      \Gamma', a \of {\rho} A \vdash T_1 \of{\sigma} C[\mathbf{inl}\, a/x] && 
      \Gamma', b \of{\pi} B \vdash T_2 \of{\sigma} C[\mathbf{inr}\, b/x] &&
      0\Gamma = 0\Gamma'    
    }\\
    \\
    \infer[\oplus \text{-comp}]{\Gamma' + \rho\Gamma \vdash \bcase(\binl(S_1), T_1, T_2) \equiv T_1[S_1 / a]}{
      \Gamma \vdash S_1 \of{\sigma} A &&
      \Gamma \vdash M \of{\sigma} \rho A \oplus \pi B &&
      \Gamma', a \of {\rho} A \vdash T_1 \of{\sigma} C[\mathbf{inl}\, a/x] && 
      0\Gamma = 0\Gamma'    
    }\\
  \end{gather*}
  \caption{Rules for $\oplus$-type}
\end{figure}
We give the following semantics for the $\oplus$-type:\\
$|\rho A \oplus \pi B\;(\gamma)| \define |A(\gamma)| \sqcup |B(\gamma)|$\\
$\begin{aligned}
  a \vDash_{\rho A \oplus \pi B\;(\gamma)} (i , x) \text{ iff } &(\exists b .  a =[!_\rho b, \ulcorner true \urcorner] \land b \vDash_{A(\gamma)} x \land i = 0)\; \lor \\
  &(\exists c .  a =[!_\pi c, \ulcorner false \urcorner] \land c \vDash_{B(\gamma)} x \land i = 1)
\end{aligned}$
\begin{claim}
  The rules are sound when interpreted wrt to the given semantics for $\oplus$-types and realisability model.
\end{claim}
\begin{proof}
  The underlying set-theoretic functions are immediate. For the realisers, let
  \begin{itemize}[noitemsep]
    \item $a_\binl \define \lambda^* x . [ F_\rho \cdot\ !_\rho a_{s_1}\cdot x , \ulcorner true \urcorner]$\\
    
    \emph{if $a_{s_1}\cdot {a_\gamma} \vDash  s_1$, then $a_\binl \cdot !_\rho a_\gamma \vDash \binl s_1$; $a_\binl \cdot !_\rho a_\gamma \leadsto [!_\rho (a_{s_1} \cdot a_\gamma) , \ulcorner true \urcorner]$}\\
    
    \item $a_\bcase \define 
    \begin{aligned}
      \lambda^* x .\text{ let } & [a'_\gamma, a_\gamma] = x, \\
      &[a , b] = a_m \cdot a_\gamma \text{ in }\\
      & E(b, a_{T_1}, a_{T_2}) \cdot [ a'_\gamma , a]      
    \end{aligned}$\\
    \\
    \emph{assuming $a_m \cdot a_\gamma \vDash M$,  $a_{T_1} \cdot [a'_\gamma, !_\rho a_a] \vDash T_1$, $a_{T_2} \cdot [a'_\gamma, !_\pi a_b] \vDash T_2$, then we want to find $a_\bcase$, s.t.\ $a_\bcase\cdot [a'_\gamma, a_\gamma] \vDash \bcase(M, T_1, T_2)$.\\ 
      \subitem if $a_m \cdot a_\gamma = [!_\rho a_a , \ulcorner true \urcorner]$, then $a_\bcase \cdot [a_\gamma , a'_\gamma] \leadsto E(\ulcorner true \urcorner, a_{T_1}, a_{T_2})\cdot [a'_
      \gamma, !_\rho a_a] \leadsto a_{T_1} \cdot [a'_\gamma, !_\rho a_a]$
      \subitem if $a_m \cdot a_\gamma = [!_\pi a_b, \ulcorner false \urcorner]$, then $\dots$} 
  \end{itemize}
\end{proof}

\begin{claim}
  There is a bijection:
  $$RTm(\Gamma, \Pi (x \of{\tau} \rho A \oplus \pi B)\, C) \cong RTm(\Gamma, \Pi (y \of{\tau\rho}A)\, C[\binl y /x]) \times RTm(\Gamma, \Pi(z \of{\tau\pi} B)\, C[\binl z /x]))$$
  \textit{(natural in $\Gamma$).}
\end{claim}

\begin{proof}
  Given a term $\Gamma \vdash f \of{1} (x \of \tau \rho A \oplus \pi B) \to C$, we can derive another term\\ $\Gamma \vdash f^l \of{1} ( y \of {\tau \rho} A) \to C[\binl y /x]$:
  $$
  \infer[Lam]{\Gamma \vdash \lambda y \of{\tau\rho} A .\, f (\binl y) : (y \of {\tau \rho} A) \to C[\binl y / x]}{
    \infer[App]{\Gamma , y \of{\tau\rho} A \vdash f(\binl y) \of{1} C[\binl y /x] }{
      \infer[Weak]{\Gamma , y \of{0} A \vdash f \of{1} (x \of\tau \rho A \oplus \pi B) \to C}{
        \Gamma \vdash f : (x \of \tau \rho A \oplus \pi B) \to C
      }
      &
      \infer[inl]{0\Gamma, y \of\rho A \vdash \binl y \of{1}\rho A \oplus \pi B}{
        \infer[var]{0\Gamma, y \of{1} \vdash y \of{1} A}{
          \vdash 0\Gamma, y \of{1} A
        }
      }
    }
  }
  $$
  Analogously, we can obtain $\Gamma \vdash f^r \of{1} (z \of{\tau\pi} B) \to C[\binr y /x]$.\\
  Now suppose we have terms $\Gamma \vdash l \of{1} (y \of{\tau \rho} A) \to C[\binl y /x]$ and $\Gamma \vdash r \of{1} (z \of{\tau \pi} B) \to C[\binr z / x]$. Using the isomorphism $\Lambda^\mathcal{L}$, we get judgements $ \Gamma, y \of{\tau \rho} A \vdash l^* : C[\binl y / x]$ and\\ $\Gamma , z \of {\tau \pi} B \vdash r^* : C[\binr z /x]$.
\end{proof}


\end{document}
